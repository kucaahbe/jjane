<%= title 'Sorting pages' %>

<% content_for :head do -%>
  <script type="text/javascript">
    //<![CDATA[
  var l_shift = <%= @level_shift %>;
  var max_level = <%= @max_level %>;
  function get_class_by_regexp(e,reg_exp) {
    classList = e.attr('class').split(' ');result = null;re = new RegExp(reg_exp);
    $.each(classList, function(index, klass) {
	    if ( re.exec(klass)!=null ) { result = klass; }
	    });
    return result;
  };
function level(e) {return parseInt(get_class_by_regexp(e,/level_\d+/).replace(/level_/,''));};
function new_level(e,level_value) {
  old_class = get_class_by_regexp(e,/level_\d+/);
  e.removeClass(old_class);
  e.addClass('level_'+level_value);
};
function lft(e) {return parseInt(get_class_by_regexp(e,/lft_\d+/).replace(/lft_/,''));};
function rgt(e) {return parseInt(get_class_by_regexp(e,/rgt_\d+/).replace(/rgt_/,''));};
function top_neighbor_of(e) {return e.prevUntil('ul').first();};
  $(function() {
      $('#sortable_pages').sortable({ 
cursor: 'move',
handle:'.mover',
tolerance: 'pointer',
grid: [l_shift, 31],
placeholder: 'ui-state-highlight',
// callbacks:
start: function(event,ui) {
ui.helper.css('border','1px solid transparent');
},
beforeStop: function(event,ui) {
level_shift = Math.round(ui.position.left/l_shift);
if (level_shift > max_level) {level_shift=max_level+1;};
new_level(ui.helper,level(ui.helper)+level_shift);
//--------------------------------------
ui.helper.css('border','1px solid blue');
ui.helper.css('padding-left',(27+level(ui.helper)*l_shift)+'px')
},
update: function(event,ui){
//send ajax to server
}
});
      $("#sortable_pages").disableSelection();
      });
//]]>
</script>
<style type="text/css">
  #sortable_pages {list-style-type:none;margin:0;padding:0;width:60%;}
  #sortable_pages li {
    margin:3px;
    padding:3px;
    font-size:15px;
    border:1px solid blue;
  }
  #sortable_pages li span {
    display:inline-block;
    vertical-align:middle;
  }
  .ui-state-highlight {height:20px;}
</style>
<% end -%>

<ul class="jjane" id="sortable_pages">
  <%- @pages.each do |p| -%>
    <% content_tag :li, :id => "page_#{p[:page].id}", :class => %[level_#{p[:level]} lft_#{p[:page].lft} rgt_#{p[:page].rgt}], :style => %[padding-left:#{27+@level_shift*p[:level]}px;] do %>
      <%= content_tag :span, '', :class => 'mover ui-icon ui-icon-arrow-4' %>
      <%= p[:page].menu %>
    <% end %>
  <%- end -%>
</ul>
